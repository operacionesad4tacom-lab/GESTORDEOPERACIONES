<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SIGO â€” Vista de Turno</title>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>

<!-- SIDEBAR -->
<aside class="sidebar" id="sidebar">
  <div class="sidebar-logo">
    <img src="assets/escudo.jpg" alt="Carabineros">
    <div class="sidebar-logo-text">
      <span class="title">SIGO</span>
      <span class="subtitle">GestiÃ³n Operacional</span>
    </div>
  </div>
  <div class="sidebar-unit">4Âª ComisarÃ­a â€” Operaciones</div>
  <nav class="sidebar-nav">
    <div class="nav-section-label">Principal</div>
    <a class="nav-item active" href="index.html"><span class="nav-icon">ğŸ </span> Vista de Turno</a>
    <a class="nav-item" href="tareas.html"><span class="nav-icon">ğŸ“‹</span> Tareas y Cuentas <span class="nav-badge" id="badge-tareas" style="display:none;">0</span></a>
    <a class="nav-item" href="calendario.html"><span class="nav-icon">ğŸ“…</span> Calendario</a>
    <div class="nav-section-label">Gestiones</div>
    <a class="nav-item" href="gestiones.html"><span class="nav-icon">ğŸ”µ</span> Gestiones <span class="nav-badge" id="badge-gestiones" style="display:none;">0</span></a>
    <div class="nav-section-label">Documentos</div>
    <a class="nav-item" href="documentos.html"><span class="nav-icon">ğŸ“¥</span> Documentos DOE <span class="nav-badge" id="badge-docs" style="display:none;">0</span></a>
    <div class="nav-section-label">Control</div>
    <a class="nav-item" href="rutinas.html"><span class="nav-icon">ğŸ”</span> Rutinas <span class="nav-badge" id="badge-rutinas" style="display:none;">0</span></a>
    <a class="nav-item" href="formatos.html"><span class="nav-icon">ğŸ“</span> Formatos Oficiales</a>
    <a class="nav-item" href="avisos.html"><span class="nav-icon">ğŸ“¢</span> Avisos</a>
    <div class="nav-section-label">Admin</div>
    <a class="nav-item" href="usuarios.html"><span class="nav-icon">ğŸ‘¤</span> Usuarios</a>
  </nav>
  <div class="sidebar-footer">
    <div class="user-avatar" id="user-avatar">?</div>
    <div class="user-info">
      <div class="name" id="user-name">Cargando...</div>
      <div class="role" id="user-role">â€”</div>
    </div>
    <button onclick="SIGO.logout()" style="background:none;border:none;color:rgba(255,255,255,0.5);cursor:pointer;font-size:16px;" title="Cerrar sesiÃ³n">â»</button>
  </div>
</aside>
<div class="sidebar-overlay" id="sidebar-overlay" onclick="SIGO.toggleSidebar()"></div>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <button class="btn-hamburger" onclick="SIGO.toggleSidebar()">â˜°</button>
    <div class="topbar-title" id="topbar-titulo">Vista de Turno</div>
    <div class="topbar-date">
      <div class="fecha" id="topbar-fecha"></div>
      <div id="topbar-hora"></div>
    </div>
    <button onclick="SIGO.logout()" class="btn btn-outline" style="margin-left:12px;font-size:12px;">â» Salir</button>
  </div>

  <!-- BANDA URGENTE -->
  <div class="banda-urgente hidden" id="banda-urgente">
    <span>ğŸš¨</span>
    <span id="banda-texto"></span>
    <button onclick="verAvisoUrgente()" class="btn btn-sm" style="background:rgba(255,255,255,0.2);color:#fff;border:1px solid rgba(255,255,255,0.4);margin-left:auto;">Ver detalle</button>
  </div>

  <div class="content">
    <div style="display:grid;grid-template-columns:1fr 280px;gap:20px;align-items:start;">

      <!-- COLUMNA IZQUIERDA -->
      <div>
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
          <div>
            <h2 style="font-family:'Barlow Condensed',sans-serif;font-size:20px;color:var(--verde-oscuro);">Pendientes del DÃ­a</h2>
            <div id="resumen-estado" style="font-size:12px;color:var(--text-secondary);margin-top:2px;">Cargando...</div>
          </div>
          <button onclick="refrescarTurno()" class="btn btn-outline" style="font-size:12px;">â†º Actualizar</button>
        </div>

        <div id="lista-pendientes">
          <div class="card" style="text-align:center;padding:40px;color:var(--text-muted);">
            <div style="font-size:32px;margin-bottom:8px;">â³</div>
            Cargando tareas del dÃ­a...
          </div>
        </div>

        <!-- COMPLETADAS -->
        <div class="completadas-section" id="seccion-completadas" style="display:none;">
          <button class="completadas-toggle" onclick="toggleCompletadas()">
            <span id="arrow-completadas">â–¶</span>
            <span>âœ… Completadas hoy</span>
            <span class="completadas-count" id="count-completadas">0</span>
          </button>
          <div class="hidden" id="lista-completadas"></div>
        </div>
      </div>

      <!-- COLUMNA DERECHA -->
      <div>
        <!-- ICO -->
        <div class="card" style="text-align:center;padding:20px;margin-bottom:16px;">
          <div class="ico-grande" id="ico-grande">
            <span class="pct" id="ico-pct">â€”</span>
            <span class="lbl">ICO HOY</span>
          </div>
          <div style="font-size:13px;font-weight:600;color:var(--text-primary);" id="ico-cuentas-txt">â€” cuentas</div>
          <div style="font-size:11px;color:var(--text-secondary);margin-top:4px;" id="ico-rutinas-txt">â€” rutinas atrasadas</div>
        </div>

        <!-- SEMANA -->
        <div class="card" style="padding:16px;margin-bottom:16px;">
          <div style="font-size:12px;font-weight:600;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:10px;">Semana actual</div>
          <div class="semana-grid" id="semana-grid"></div>
        </div>

        <!-- MAÃ‘ANA -->
        <div class="card" style="padding:16px;">
          <div style="font-size:12px;font-weight:600;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:10px;">MaÃ±ana</div>
          <div id="lista-proximas">
            <div class="text-sm text-muted">Cargando...</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL MARCAR -->
<div class="modal-overlay" id="modal-marcar">
  <div class="modal" style="max-width:480px;">
    <div class="modal-header">
      <h3>âœ… Registrar Cuenta Respondida</h3>
      <button class="modal-close" onclick="SIGO.closeModal('modal-marcar')">âœ•</button>
    </div>
    <div class="modal-body">
      <p id="marcar-titulo" style="font-weight:700;font-size:15px;margin-bottom:16px;"></p>
      <div class="form-group">
        <label>ObservaciÃ³n (recomendada)</label>
        <textarea id="marcar-obs" class="form-control" rows="3"
          placeholder="Ej: Se enviÃ³ a las 08:30 hrs. NCU 247/2026. Sin novedades..."></textarea>
      </div>
      <div class="alert alert-success" style="font-size:12px;">
        ğŸ’¡ Las observaciones quedan en el historial y son visibles por todos.
      </div>
      <input type="hidden" id="marcar-id">
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="SIGO.closeModal('modal-marcar')">Cancelar</button>
      <button class="btn btn-primary" onclick="confirmarMarcado()">âœ… Confirmar</button>
    </div>
  </div>
</div>

<!-- MODAL AVISO URGENTE -->
<div class="modal-overlay" id="modal-aviso-urgente">
  <div class="modal" style="max-width:500px;">
    <div class="modal-header" style="background:var(--danger);">
      <h3>ğŸš¨ Aviso Urgente</h3>
      <button class="modal-close" onclick="SIGO.closeModal('modal-aviso-urgente')">âœ•</button>
    </div>
    <div class="modal-body" id="modal-aviso-cuerpo"></div>
    <div class="modal-footer">
      <button class="btn btn-primary" onclick="SIGO.closeModal('modal-aviso-urgente')">Entendido</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="js/supabase.js"></script>
<script>
let currentUser = null;
let avisosUrgentes = [];
let tareasPendientes = [];
let tareasCompletadas = [];
let completadasVisible = false;

// â”€â”€ Reloj topbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function actualizarReloj() {
  const ahora = new Date();
  const dias = ['Domingo','Lunes','Martes','MiÃ©rcoles','Jueves','Viernes','SÃ¡bado'];
  const meses = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
  document.getElementById('topbar-fecha').textContent =
    `${dias[ahora.getDay()]} ${ahora.getDate()} ${meses[ahora.getMonth()]}`;
  document.getElementById('topbar-hora').textContent =
    ahora.toLocaleTimeString('es-CL', { hour:'2-digit', minute:'2-digit' }) + ' hrs';
}

function esUrgente(horaLimite) {
  if (!horaLimite) return false;
  const [h, m] = horaLimite.split(':').map(Number);
  const limite = new Date();
  limite.setHours(h, m, 0);
  const diff = (limite - new Date()) / 60000;
  return diff > 0 && diff <= 60;
}

// â”€â”€ Render lista pendientes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPendientes(lista) {
  const el = document.getElementById('lista-pendientes');
  if (!lista.length) {
    el.innerHTML = `<div class="card" style="text-align:center;padding:40px;color:var(--text-muted);">
      <div style="font-size:40px;margin-bottom:8px;">ğŸ‰</div>
      <strong>Â¡Todo al dÃ­a!</strong><br>No hay cuentas pendientes para hoy.
    </div>`;
    return;
  }
  el.innerHTML = lista.map(item => {
    let clase = '';
    if (item._atrasada) clase = 'atrasada';
    else if (item.tipo === 'gestion') clase = 'gestion';
    else if (esUrgente(item.hora_limite)) clase = 'urgente';

    const respNombre = item.responsable ? `${item.responsable.grado} ${item.responsable.nombre}` : 'â€”';
    const hora = item.hora_limite ? item.hora_limite.substring(0,5) : '';
    const areaBadge = item.area ? `<span class="badge badge-normal">${item.area}</span>` : '';
    const atrasadaBadge = item._atrasada
      ? `<span class="badge-atrasada-inline">ATRASADA Â· hace ${item._diasMora} dÃ­a${item._diasMora>1?'s':''}</span>` : '';

    return `<div class="turno-item ${clase}" data-id="${item.id}">
      <button class="turno-check" onclick="abrirModalMarcar('${item.id}','${item.titulo.replace(/'/g,"\\'")}')">
        <div class="check-circle"></div>
      </button>
      <div class="turno-info">
        <div class="turno-titulo">${item.titulo}${atrasadaBadge}</div>
        <div class="turno-meta">${areaBadge} ${item.tipo || ''} Â· ${respNombre}</div>
      </div>
      <div class="turno-hora">${hora}</div>
      ${SIGO.badgePrioridad(item.prioridad || 'normal')}
    </div>`;
  }).join('');
}

function renderCompletadas(lista) {
  const el = document.getElementById('lista-completadas');
  const count = document.getElementById('count-completadas');
  count.textContent = lista.length;
  if (!lista.length) { el.innerHTML = '<div style="padding:12px 18px;color:var(--text-muted);font-size:12px;">Sin completadas aÃºn.</div>'; return; }
  el.innerHTML = lista.map(e => {
    const hora = e.created_at ? new Date(e.created_at).toLocaleTimeString('es-CL',{hour:'2-digit',minute:'2-digit'}) : '';
    return `<div class="completada-item">
      <span style="font-size:18px;">âœ…</span>
      <div style="flex:1">
        <div class="completada-titulo">${e._tarea?.titulo || 'Tarea'}</div>
        ${e.observaciones ? `<div class="completada-obs">"${e.observaciones}"</div>` : ''}
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;">
        <div class="completada-hora">${hora}</div>
        <button class="btn btn-sm btn-outline" onclick="desmarcar('${e.tarea_id}')">â†©</button>
      </div>
    </div>`;
  }).join('');
}

function toggleCompletadas() {
  completadasVisible = !completadasVisible;
  document.getElementById('lista-completadas').classList.toggle('hidden', !completadasVisible);
  document.getElementById('arrow-completadas').textContent = completadasVisible ? 'â–¼' : 'â–¶';
}

// â”€â”€ Mini semana â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderSemana() {
  const grid = document.getElementById('semana-grid');
  const letras = ['L','M','X','J','V','S','D'];
  let html = '';
  for (let i = -6; i <= 0; i++) {
    const d = new Date();
    d.setDate(d.getDate() + i);
    const iso = d.toISOString().split('T')[0];
    const esHoy = i === 0;
    const letraIdx = (d.getDay() + 6) % 7;
    try {
      const tareas = await SIGO.getTareasDelDia(iso);
      const ejecuciones = await SIGO.getEjecucionesDelDia(iso);
      const ejIds = new Set(ejecuciones.map(e => e.tarea_id));
      let clase = 'vacio';
      let texto = '';
      if (tareas.length > 0) {
        const todas = tareas.every(t => ejIds.has(t.id));
        clase = todas ? 'ok' : (i < 0 ? 'falta' : 'vacio');
        texto = todas ? 'â—' : (i < 0 ? 'â—' : '');
      }
      html += `<div class="semana-dia ${esHoy ? 'hoy' : clase}">
        <div class="dia-letra">${letras[letraIdx]}</div>
        <div class="dia-punto">${texto}</div>
      </div>`;
    } catch {
      html += `<div class="semana-dia vacio"><div class="dia-letra">${letras[letraIdx]}</div><div class="dia-punto"></div></div>`;
    }
  }
  grid.innerHTML = html;
}

// â”€â”€ PrÃ³ximas (maÃ±ana) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderProximas() {
  const manana = new Date();
  manana.setDate(manana.getDate() + 1);
  const iso = manana.toISOString().split('T')[0];
  try {
    const tareas = await SIGO.getTareasDelDia(iso);
    const el = document.getElementById('lista-proximas');
    if (!tareas.length) {
      el.innerHTML = '<div class="text-sm text-muted">Sin cuentas programadas.</div>';
      return;
    }
    el.innerHTML = tareas.slice(0, 3).map(t =>
      `<div class="proximas-item">
        <strong style="font-size:12px;">${t.titulo}</strong>
        ${t.hora_limite ? `<span class="text-muted" style="float:right;">${t.hora_limite.substring(0,5)}</span>` : ''}
      </div>`
    ).join('') + (tareas.length > 3 ? `<div class="text-sm text-muted" style="margin-top:6px;">+${tareas.length-3} mÃ¡s...</div>` : '');
  } catch { }
}

// â”€â”€ Banda urgente â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function cargarBandaUrgente() {
  try {
    const avisos = await SIGO.getAvisos();
    avisosUrgentes = avisos.filter(a => a.tipo === 'urgente');
    const banda = document.getElementById('banda-urgente');
    if (!avisosUrgentes.length) { banda.classList.add('hidden'); return; }
    banda.classList.remove('hidden');
    document.getElementById('banda-texto').textContent =
      `AVISO: ${avisosUrgentes[0].titulo}${avisosUrgentes.length > 1 ? ` (+${avisosUrgentes.length-1} mÃ¡s)` : ''}`;
  } catch { }
}

function verAvisoUrgente() {
  if (!avisosUrgentes.length) return;
  const a = avisosUrgentes[0];
  document.getElementById('modal-aviso-cuerpo').innerHTML = `
    <p style="font-weight:700;font-size:15px;margin-bottom:8px;">${a.titulo}</p>
    <p style="font-size:13px;color:var(--text-secondary);">${a.contenido || ''}</p>
    ${a.fecha_vigencia ? `<p class="text-sm text-muted" style="margin-top:12px;">Vigente hasta: ${SIGO.formatFecha(a.fecha_vigencia)}</p>` : ''}
  `;
  SIGO.openModal('modal-aviso-urgente');
}

// â”€â”€ Detectar atrasadas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function detectarAtrasadas() {
  const atrasadas = [];
  for (let i = 7; i >= 1; i--) {
    const d = new Date();
    d.setDate(d.getDate() - i);
    const iso = d.toISOString().split('T')[0];
    try {
      const tareas = await SIGO.getTareasDelDia(iso);
      const ejecuciones = await SIGO.getEjecucionesDelDia(iso);
      const ejIds = new Set(ejecuciones.map(e => e.tarea_id));
      tareas.forEach(t => {
        if (!ejIds.has(t.id) && t.tipo !== 'extraordinaria') {
          // Solo agregar si no hay otra atrasada igual
          if (!atrasadas.find(a => a.id === t.id)) {
            atrasadas.push({ ...t, _atrasada: true, _diasMora: i });
          }
        }
      });
    } catch { }
  }
  return atrasadas;
}

// â”€â”€ ICO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function actualizarICO(total, completadas, rutinasAtrasadas) {
  const pct = total > 0 ? Math.round((completadas / total) * 100) : 100;
  document.getElementById('ico-pct').textContent = pct + '%';
  document.getElementById('ico-cuentas-txt').textContent = `${completadas} de ${total} cuentas`;
  document.getElementById('ico-rutinas-txt').textContent = `${rutinasAtrasadas} rutinas atrasadas`;
  const circle = document.getElementById('ico-grande');
  const color = pct >= 80 ? 'var(--verde-oscuro)' : pct >= 50 ? 'var(--warning)' : 'var(--danger)';
  circle.style.borderColor = color;
}

// â”€â”€ Actualizar badges sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function actualizarBadges(pendientes, docsNuevos, rutinasAtrasadas) {
  const bt = document.getElementById('badge-tareas');
  bt.textContent = pendientes;
  bt.style.display = pendientes > 0 ? 'inline' : 'none';
  const bd = document.getElementById('badge-docs');
  bd.textContent = docsNuevos;
  bd.style.display = docsNuevos > 0 ? 'inline' : 'none';
  const br = document.getElementById('badge-rutinas');
  br.textContent = rutinasAtrasadas;
  br.style.display = rutinasAtrasadas > 0 ? 'inline' : 'none';
}

// â”€â”€ Refrescar turno â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function refrescarTurno() {
  const hoy = new Date().toISOString().split('T')[0];
  try {
    const [tareas, ejecuciones, atrasadas, rutinas, docs] = await Promise.all([
      SIGO.getTareasDelDia(hoy),
      SIGO.getEjecucionesDelDia(hoy),
      detectarAtrasadas(),
      SIGO.getRutinas(),
      SIGO.getDocumentos()
    ]);

    const ejIds = new Set(ejecuciones.map(e => e.tarea_id));
    const ejMap = {};
    ejecuciones.forEach(e => ejMap[e.tarea_id] = e);

    // Pendientes del dÃ­a (sin ejecuciÃ³n hoy)
    const pendientesHoy = tareas
      .filter(t => !ejIds.has(t.id))
      .map(t => ({ ...t }));

    // Completadas del dÃ­a (con ejecuciÃ³n hoy)
    const completadasHoy = ejecuciones.map(e => ({
      ...e,
      _tarea: tareas.find(t => t.id === e.tarea_id)
    })).filter(e => e._tarea);

    // Ordenar: atrasadas primero, luego por hora
    const ordenAtrasadas = atrasadas.sort((a, b) => (b._diasMora - a._diasMora));
    const pendientesOrdenados = [
      ...ordenAtrasadas,
      ...pendientesHoy.sort((a, b) => {
        if (!a.hora_limite && !b.hora_limite) return 0;
        if (!a.hora_limite) return 1;
        if (!b.hora_limite) return -1;
        return a.hora_limite.localeCompare(b.hora_limite);
      })
    ];

    tareasPendientes = pendientesOrdenados;
    tareasCompletadas = completadasHoy;

    renderPendientes(pendientesOrdenados);
    renderCompletadas(completadasHoy);

    const secComp = document.getElementById('seccion-completadas');
    secComp.style.display = completadasHoy.length > 0 ? 'block' : 'none';

    // Resumen
    const total = tareas.length;
    const comp = completadasHoy.length;
    const atrasadasCount = atrasadas.length;
    const rutinasAtrasadas = rutinas.filter(r => r.estado === 'atrasada').length;
    const docsNuevos = docs.filter(d => d.estado === 'nuevo').length;

    document.getElementById('resumen-estado').textContent =
      `${pendientesOrdenados.length} pendiente${pendientesOrdenados.length !== 1 ? 's' : ''} Â· ${comp} completada${comp !== 1 ? 's' : ''} hoy${atrasadasCount > 0 ? ` Â· âš ï¸ ${atrasadasCount} atrasada${atrasadasCount > 1 ? 's' : ''}` : ''}`;

    actualizarICO(total, comp, rutinasAtrasadas);
    actualizarBadges(pendientesOrdenados.length, docsNuevos, rutinasAtrasadas);

  } catch (err) {
    console.error(err);
    document.getElementById('lista-pendientes').innerHTML =
      `<div class="alert alert-warning">âš ï¸ Error al cargar tareas: ${err.message}</div>`;
  }
}

// â”€â”€ Modal marcar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function abrirModalMarcar(id, titulo) {
  document.getElementById('marcar-id').value = id;
  document.getElementById('marcar-titulo').textContent = titulo;
  document.getElementById('marcar-obs').value = '';
  SIGO.openModal('modal-marcar');
}

async function confirmarMarcado() {
  const id = document.getElementById('marcar-id').value;
  const obs = document.getElementById('marcar-obs').value;
  try {
    await SIGO.registrarEjecucion(id, currentUser.id, obs);
    SIGO.closeModal('modal-marcar');
    SIGO.showToast('âœ… Cuenta registrada correctamente');
    await refrescarTurno();
  } catch (err) {
    SIGO.showToast('âŒ Error: ' + err.message, 'warning');
  }
}

async function desmarcar(tareaId) {
  if (!confirm('Â¿Desmarcar esta cuenta? Se eliminarÃ¡ el registro de hoy.')) return;
  const hoy = new Date().toISOString().split('T')[0];
  try {
    await SIGO.eliminarEjecucion(tareaId, hoy);
    SIGO.showToast('â†© Cuenta desmarcada');
    await refrescarTurno();
  } catch (err) {
    SIGO.showToast('âŒ Error: ' + err.message, 'warning');
  }
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  actualizarReloj();
  setInterval(actualizarReloj, 30000);

  const user = await SIGO.authGuard();
  if (!user) return;
  currentUser = user;
  const profile = await SIGO.getUserProfile(user.id);
  if (profile) {
    document.getElementById('user-name').textContent = profile.nombre;
    document.getElementById('user-role').textContent = profile.grado || profile.rol;
    document.getElementById('user-avatar').textContent = profile.nombre?.charAt(0) || '?';
    document.getElementById('topbar-titulo').textContent =
      `Turno Â· ${profile.grado ? profile.grado + ' ' : ''}${profile.nombre}`;
  }

  await Promise.all([
    refrescarTurno(),
    cargarBandaUrgente(),
    renderSemana(),
    renderProximas()
  ]);
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
