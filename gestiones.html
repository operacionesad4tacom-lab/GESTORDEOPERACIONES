<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SIGO â€” Gestiones</title>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>

<aside class="sidebar" id="sidebar">
  <div class="sidebar-logo">
    <img src="assets/escudo.jpg" alt="Carabineros">
    <div class="sidebar-logo-text">
      <span class="title">SIGO</span>
      <span class="subtitle">GestiÃ³n Operacional</span>
    </div>
  </div>
  <div class="sidebar-unit">4Âª ComisarÃ­a â€” Operaciones</div>
  <nav class="sidebar-nav">
    <div class="nav-section-label">Principal</div>
    <a class="nav-item" href="index.html"><span class="nav-icon">ğŸ </span> Vista de Turno</a>
    <a class="nav-item" href="tareas.html"><span class="nav-icon">ğŸ“‹</span> Tareas y Cuentas</a>
    <a class="nav-item" href="calendario.html"><span class="nav-icon">ğŸ“…</span> Calendario</a>
    <div class="nav-section-label">Gestiones</div>
    <a class="nav-item active" href="gestiones.html"><span class="nav-icon">ğŸ”µ</span> Gestiones</a>
    <div class="nav-section-label">Documentos</div>
    <a class="nav-item" href="documentos.html"><span class="nav-icon">ğŸ“¥</span> Documentos DOE</a>
    <div class="nav-section-label">Control</div>
    <a class="nav-item" href="rutinas.html"><span class="nav-icon">ğŸ”</span> Rutinas</a>
    <a class="nav-item" href="formatos.html"><span class="nav-icon">ğŸ“</span> Formatos Oficiales</a>
    <a class="nav-item" href="avisos.html"><span class="nav-icon">ğŸ“¢</span> Avisos</a>
    <div class="nav-section-label">Admin</div>
    <a class="nav-item" href="usuarios.html"><span class="nav-icon">ğŸ‘¤</span> Usuarios</a>
  </nav>
  <div class="sidebar-footer">
    <div class="user-avatar" id="user-avatar">?</div>
    <div class="user-info">
      <div class="name" id="user-name">Cargando...</div>
      <div class="role" id="user-role">â€”</div>
    </div>
    <button onclick="SIGO.logout()" style="background:none;border:none;color:rgba(255,255,255,0.5);cursor:pointer;font-size:16px;">â»</button>
  </div>
</aside>
<div class="sidebar-overlay" id="sidebar-overlay" onclick="SIGO.toggleSidebar()"></div>

<div class="main">
  <div class="topbar">
    <button class="btn-hamburger" onclick="SIGO.toggleSidebar()">â˜°</button>
    <div class="topbar-title">ğŸ”µ Gestiones</div>
    <button onclick="SIGO.openModal('modal-nueva-gestion')" class="btn btn-primary" style="margin-left:auto;">ğŸ”µ Nueva GestiÃ³n</button>
  </div>

  <div class="content">
    <div class="tab-bar" style="max-width:300px;">
      <button class="tab-btn active" onclick="cambiarVista('activas', this)">ğŸ”µ Activas</button>
      <button class="tab-btn" onclick="cambiarVista('cerradas', this)">ğŸ—„ Cerradas</button>
    </div>

    <div id="lista-gestiones">
      <div style="text-align:center;padding:40px;color:var(--text-muted);">Cargando...</div>
    </div>
  </div>
</div>

<!-- MODAL NUEVA GESTIÃ“N -->
<div class="modal-overlay" id="modal-nueva-gestion">
  <div class="modal">
    <div class="modal-header">
      <h3>ğŸ”µ Nueva GestiÃ³n</h3>
      <button class="modal-close" onclick="SIGO.closeModal('modal-nueva-gestion')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Nombre *</label>
        <input type="text" id="ng-nombre" class="form-control"
          placeholder="Ej: EvaluaciÃ³n Hipoxia â€” 10 funcionarios">
      </div>
      <div class="form-group">
        <label>Objetivo *</label>
        <textarea id="ng-objetivo" class="form-control" rows="2"
          placeholder="Â¿QuÃ© se quiere lograr con esta gestiÃ³n?"></textarea>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Ãrea</label>
          <select id="ng-area" class="form-control">
            <option value="Operaciones">Operaciones</option>
            <option value="SIP">SIP</option>
            <option value="OS2">OS2</option>
            <option value="OS3">OS3</option>
            <option value="Frontera">Frontera</option>
            <option value="Administrativo">Administrativo</option>
          </select>
        </div>
        <div class="form-group">
          <label>Prioridad</label>
          <select id="ng-prioridad" class="form-control">
            <option value="normal">Normal</option>
            <option value="alta">Alta</option>
            <option value="critica">CrÃ­tica</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label>Fecha LÃ­mite (opcional)</label>
        <input type="date" id="ng-fecha-limite" class="form-control">
      </div>
      <hr style="border-color:var(--border);margin:8px 0 16px;">
      <div class="form-group">
        <label>Primer hito (opcional â€” podÃ©s agregarlo despuÃ©s)</label>
        <input type="text" id="ng-primer-hito" class="form-control"
          placeholder="Ej: DOE enviado solicitando horas de evaluaciÃ³n">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="SIGO.closeModal('modal-nueva-gestion')">Cancelar</button>
      <button class="btn btn-primary" onclick="crearGestion()">ğŸ’¾ Crear GestiÃ³n</button>
    </div>
  </div>
</div>

<!-- MODAL DETALLE / LÃNEA DE TIEMPO -->
<div class="modal-overlay" id="modal-gestion-detalle">
  <div class="modal" style="max-width:700px;">
    <div class="modal-header">
      <h3 id="gd-titulo"></h3>
      <button class="modal-close" onclick="SIGO.closeModal('modal-gestion-detalle')">âœ•</button>
    </div>
    <div class="modal-body">
      <p id="gd-objetivo" style="color:var(--text-secondary);margin-bottom:4px;"></p>
      <div style="font-size:11px;color:var(--text-muted);margin-bottom:20px;" id="gd-meta"></div>

      <div class="timeline" id="gd-timeline"></div>

      <div style="display:flex;gap:10px;margin-top:20px;flex-wrap:wrap;">
        <button class="btn btn-secondary" onclick="abrirAgregarHito()">â• Agregar hito</button>
        <button class="btn btn-outline" style="color:var(--danger);border-color:var(--danger);" onclick="confirmarCerrarGestion()">ğŸ”’ Cerrar GestiÃ³n</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL AGREGAR HITO -->
<div class="modal-overlay" id="modal-nuevo-hito">
  <div class="modal" style="max-width:480px;">
    <div class="modal-header">
      <h3>â• Agregar Hito</h3>
      <button class="modal-close" onclick="SIGO.closeModal('modal-nuevo-hito')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>DescripciÃ³n *</label>
        <input type="text" id="nh-descripcion" class="form-control"
          placeholder="Ej: Citar a los 10 funcionarios">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Tipo</label>
          <select id="nh-tipo" class="form-control">
            <option value="accion">AcciÃ³n pendiente</option>
            <option value="registro">Registro (ya ocurriÃ³)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Estado inicial</label>
          <select id="nh-estado" class="form-control">
            <option value="pendiente">Pendiente</option>
            <option value="completado">Completado</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Fecha</label>
          <input type="date" id="nh-fecha" class="form-control">
        </div>
        <div class="form-group">
          <label>Responsable</label>
          <select id="nh-responsable" class="form-control">
            <option value="">Sin asignar</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label>ObservaciÃ³n</label>
        <textarea id="nh-obs" class="form-control" rows="2"
          placeholder="NCU, referencias, notas relevantes..."></textarea>
      </div>
      <input type="hidden" id="nh-gestion-id">
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="SIGO.closeModal('modal-nuevo-hito')">Cancelar</button>
      <button class="btn btn-primary" onclick="guardarHito()">ğŸ’¾ Agregar</button>
    </div>
  </div>
</div>

<!-- MODAL COMPLETAR HITO -->
<div class="modal-overlay" id="modal-completar-hito">
  <div class="modal" style="max-width:400px;">
    <div class="modal-header">
      <h3>âœ… Completar Hito</h3>
      <button class="modal-close" onclick="SIGO.closeModal('modal-completar-hito')">âœ•</button>
    </div>
    <div class="modal-body">
      <p id="ch-desc" style="font-weight:700;margin-bottom:12px;"></p>
      <div class="form-group">
        <label>ObservaciÃ³n (opcional)</label>
        <textarea id="ch-obs" class="form-control" rows="2" placeholder="Resultado, referencias..."></textarea>
      </div>
      <input type="hidden" id="ch-id">
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="SIGO.closeModal('modal-completar-hito')">Cancelar</button>
      <button class="btn btn-primary" onclick="confirmarCompletarHito()">âœ… Completar</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="js/supabase.js"></script>
<script>
let currentUser = null;
let usuarios = [];
let vistaActual = 'activas';
let gestionActualId = null;

function cambiarVista(vista, btn) {
  vistaActual = vista;
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  cargarGestiones();
}

// â”€â”€ Render tarjetas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function cargarGestiones() {
  const el = document.getElementById('lista-gestiones');
  el.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted);">Cargando...</div>';
  try {
    const soloActivas = vistaActual === 'activas';
    const gestiones = await SIGO.getGestiones(soloActivas);
    if (!gestiones.length) {
      el.innerHTML = `<div class="card" style="text-align:center;padding:40px;color:var(--text-muted);">
        <div style="font-size:32px;margin-bottom:8px;">ğŸ”µ</div>
        ${soloActivas ? 'No hay gestiones activas. Crea la primera con el botÃ³n ğŸ”µ Nueva GestiÃ³n' : 'No hay gestiones cerradas.'}
      </div>`;
      return;
    }

    // Ordenar por urgencia del prÃ³ximo hito
    const ordenadas = gestiones.sort((a, b) => {
      const pa = proximoHito(a.hitos);
      const pb = proximoHito(b.hitos);
      if (!pa && !pb) return 0;
      if (!pa) return 1;
      if (!pb) return -1;
      return pa.localeCompare(pb);
    });

    el.innerHTML = ordenadas.map(g => renderTarjeta(g)).join('');
  } catch (err) {
    el.innerHTML = `<div class="alert alert-warning">âš ï¸ ${err.message}</div>`;
  }
}

function proximoHito(hitos) {
  if (!hitos?.length) return null;
  const pendientes = hitos.filter(h => h.estado === 'pendiente' && h.fecha).sort((a,b) => a.fecha.localeCompare(b.fecha));
  return pendientes[0]?.fecha || null;
}

function renderTarjeta(g) {
  const hitos = g.hitos || [];
  const total = hitos.length;
  const comp = hitos.filter(h => h.estado === 'completado').length;
  const pct = total > 0 ? Math.round((comp / total) * 100) : 0;
  const prox = proximoHito(hitos);
  const ini = g.iniciada_por ? `${g.iniciada_por.grado} ${g.iniciada_por.nombre}` : 'â€”';
  const estadoBadge = g.estado.replace(/_/g,' ');

  return `<div class="gestion-card ${g.estado}">
    <div class="gestion-card-header">
      <span class="gestion-estado-badge ${g.estado}">${estadoBadge.toUpperCase()}</span>
      <span class="badge badge-normal">${g.area}</span>
      ${SIGO.badgePrioridad(g.prioridad)}
    </div>
    <div class="gestion-titulo">${g.nombre}</div>
    <div class="gestion-objetivo">${g.objetivo || ''}</div>
    ${total > 0 ? `<div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
    <div style="font-size:11px;color:var(--text-secondary);margin-bottom:4px;">Paso ${comp} de ${total}</div>` : ''}
    ${prox ? `<div class="gestion-proximo">ğŸ“Œ PrÃ³ximo hito: ${SIGO.formatFecha(prox)}</div>` : ''}
    <div class="gestion-footer">
      <span>Iniciada por ${ini} Â· ${SIGO.tiempoRelativo(g.created_at)}</span>
      <button class="btn btn-sm btn-primary" onclick="verGestion('${g.id}')">Ver detalle â†’</button>
    </div>
  </div>`;
}

// â”€â”€ Detalle gestiÃ³n â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function verGestion(id) {
  gestionActualId = id;
  try {
    const g = await SIGO.getGestion(id);
    document.getElementById('gd-titulo').textContent = g.nombre;
    document.getElementById('gd-objetivo').textContent = g.objetivo || '';
    document.getElementById('gd-meta').textContent =
      `Ãrea: ${g.area} Â· Prioridad: ${g.prioridad} Â· ${g.fecha_limite ? 'LÃ­mite: ' + SIGO.formatFecha(g.fecha_limite) : 'Sin fecha lÃ­mite'}`;

    renderTimeline(g.hitos || []);
    SIGO.openModal('modal-gestion-detalle');
  } catch (err) {
    SIGO.showToast('âŒ Error: ' + err.message, 'warning');
  }
}

function renderTimeline(hitos) {
  const el = document.getElementById('gd-timeline');
  if (!hitos.length) {
    el.innerHTML = '<div style="color:var(--text-muted);font-size:13px;padding:10px 0;">Sin hitos. Agrega el primero.</div>';
    return;
  }
  const ordenados = [...hitos].sort((a,b) => {
    if (a.fecha && b.fecha) return a.fecha.localeCompare(b.fecha);
    return 0;
  });
  el.innerHTML = ordenados.map(h => {
    const esActivo = h.estado === 'pendiente';
    const iconoMap = { completado:'âœ“', pendiente:'Â·', cancelado:'âœ•' };
    const respNombre = h.responsable ? `${h.responsable.grado} ${h.responsable.nombre}` : '';
    return `<div class="timeline-item ${h.estado}">
      <div class="timeline-dot">${iconoMap[h.estado]||'Â·'}</div>
      <div class="timeline-content">
        <div class="timeline-titulo">${h.descripcion}</div>
        <div class="timeline-meta">
          ${h.fecha ? SIGO.formatFecha(h.fecha) : ''}
          ${respNombre ? 'Â· ' + respNombre : ''}
          ${h.observacion ? `<span class="text-muted"> â€” "${h.observacion}"</span>` : ''}
        </div>
        ${esActivo ? `<div class="timeline-acciones">
          <button class="btn btn-sm btn-primary" onclick="abrirCompletarHito('${h.id}','${h.descripcion.replace(/'/g,"\\'")}')">âœ… Completar</button>
        </div>` : ''}
      </div>
    </div>`;
  }).join('');
}

function abrirAgregarHito() {
  document.getElementById('nh-gestion-id').value = gestionActualId;
  document.getElementById('nh-descripcion').value = '';
  document.getElementById('nh-fecha').value = '';
  document.getElementById('nh-obs').value = '';
  document.getElementById('nh-tipo').value = 'accion';
  document.getElementById('nh-estado').value = 'pendiente';
  SIGO.openModal('modal-nuevo-hito');
}

async function guardarHito() {
  const desc = document.getElementById('nh-descripcion').value.trim();
  if (!desc) { SIGO.showToast('âš ï¸ La descripciÃ³n es obligatoria', 'warning'); return; }
  const hito = {
    gestion_id: document.getElementById('nh-gestion-id').value,
    descripcion: desc,
    tipo: document.getElementById('nh-tipo').value,
    estado: document.getElementById('nh-estado').value,
    fecha: document.getElementById('nh-fecha').value || null,
    responsable_id: document.getElementById('nh-responsable').value || null,
    observacion: document.getElementById('nh-obs').value || null,
  };
  try {
    await SIGO.agregarHitoGestion(hito);
    SIGO.closeModal('modal-nuevo-hito');
    SIGO.showToast('âœ… Hito agregado');
    await verGestion(gestionActualId);
    cargarGestiones();
  } catch (err) {
    SIGO.showToast('âŒ Error: ' + err.message, 'warning');
  }
}

function abrirCompletarHito(id, desc) {
  document.getElementById('ch-id').value = id;
  document.getElementById('ch-desc').textContent = desc;
  document.getElementById('ch-obs').value = '';
  SIGO.openModal('modal-completar-hito');
}

async function confirmarCompletarHito() {
  const id = document.getElementById('ch-id').value;
  const obs = document.getElementById('ch-obs').value;
  try {
    await SIGO.completarHitoGestion(id, currentUser.id, obs);
    SIGO.closeModal('modal-completar-hito');
    SIGO.showToast('âœ… Hito completado');
    await verGestion(gestionActualId);
    cargarGestiones();
  } catch (err) {
    SIGO.showToast('âŒ Error: ' + err.message, 'warning');
  }
}

async function confirmarCerrarGestion() {
  const nota = prompt('Nota de cierre (obligatoria):');
  if (!nota?.trim()) { SIGO.showToast('âš ï¸ La nota de cierre es obligatoria', 'warning'); return; }
  try {
    await SIGO.cerrarGestion(gestionActualId, currentUser.id, nota);
    SIGO.closeModal('modal-gestion-detalle');
    SIGO.showToast('ğŸ”’ GestiÃ³n cerrada');
    cargarGestiones();
  } catch (err) {
    SIGO.showToast('âŒ Error: ' + err.message, 'warning');
  }
}

// â”€â”€ Crear gestiÃ³n â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function crearGestion() {
  const nombre = document.getElementById('ng-nombre').value.trim();
  const objetivo = document.getElementById('ng-objetivo').value.trim();
  if (!nombre || !objetivo) { SIGO.showToast('âš ï¸ Nombre y objetivo son obligatorios', 'warning'); return; }
  try {
    const g = await SIGO.crearGestion({
      nombre,
      objetivo,
      area: document.getElementById('ng-area').value,
      prioridad: document.getElementById('ng-prioridad').value,
      fecha_limite: document.getElementById('ng-fecha-limite').value || null,
      iniciada_por: currentUser.id,
      estado: 'abierta'
    });
    const primerHito = document.getElementById('ng-primer-hito').value.trim();
    if (primerHito) {
      await SIGO.agregarHitoGestion({ gestion_id: g.id, descripcion: primerHito, estado: 'pendiente', tipo: 'accion' });
    }
    SIGO.closeModal('modal-nueva-gestion');
    SIGO.showToast('âœ… GestiÃ³n creada');
    document.getElementById('ng-nombre').value = '';
    document.getElementById('ng-objetivo').value = '';
    document.getElementById('ng-primer-hito').value = '';
    cargarGestiones();
  } catch (err) {
    SIGO.showToast('âŒ Error: ' + err.message, 'warning');
  }
}

async function init() {
  const user = await SIGO.authGuard();
  if (!user) return;
  currentUser = user;
  const profile = await SIGO.getUserProfile(user.id);
  if (profile) {
    document.getElementById('user-name').textContent = profile.nombre;
    document.getElementById('user-role').textContent = profile.grado || profile.rol;
    document.getElementById('user-avatar').textContent = profile.nombre?.charAt(0) || '?';
  }
  usuarios = await SIGO.getUsuarios();
  const selResp = document.getElementById('nh-responsable');
  usuarios.forEach(u => {
    selResp.innerHTML += `<option value="${u.id}">${u.grado} ${u.nombre}</option>`;
  });
  cargarGestiones();
}
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
