<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SIGO â€” Usuarios</title>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>

<aside class="sidebar">
  <div class="sidebar-logo">
    <img src="assets/escudo.jpg" alt="Carabineros">
    <div class="sidebar-logo-text"><span class="title">SIGO</span><span class="subtitle">GestiÃ³n Operacional</span></div>
  </div>
  <div class="sidebar-unit">4Âª ComisarÃ­a â€” Operaciones</div>
  <nav class="sidebar-nav">
    <div class="nav-section-label">Principal</div>
    <a class="nav-item" href="index.html"><span class="nav-icon">ğŸ </span> Dashboard</a>
    <a class="nav-item" href="tareas.html"><span class="nav-icon">ğŸ“‹</span> Tareas y Cuentas</a>
    <a class="nav-item" href="calendario.html"><span class="nav-icon">ğŸ“…</span> Calendario</a>
    <div class="nav-section-label">Documentos</div>
    <a class="nav-item" href="documentos.html"><span class="nav-icon">ğŸ“¥</span> Documentos DOE</a>
    <div class="nav-section-label">Control</div>
    <a class="nav-item" href="rutinas.html"><span class="nav-icon">ğŸ”</span> Rutinas</a>
    <a class="nav-item" href="formatos.html"><span class="nav-icon">ğŸ“</span> Formatos Oficiales</a>
    <a class="nav-item" href="avisos.html"><span class="nav-icon">ğŸ“¢</span> Avisos</a>
    <div class="nav-section-label">Admin</div>
    <a class="nav-item active" href="usuarios.html"><span class="nav-icon">ğŸ‘¤</span> Usuarios</a>
  </nav>
  <div class="sidebar-footer">
    <div class="user-avatar" id="user-avatar">?</div>
    <div class="user-info"><div class="name" id="user-name">Cargando...</div><div class="role" id="user-role">â€”</div></div>
    <button onclick="SIGO.logout()" style="background:none;border:none;color:rgba(255,255,255,0.5);cursor:pointer;font-size:16px;">â»</button>
  </div>
</aside>

<div class="main">
  <div class="topbar">
    <div class="topbar-title">GestiÃ³n de Usuarios</div>
    <button class="btn btn-primary" onclick="SIGO.openModal('modal-usuario')">â• Nuevo Usuario</button>
  </div>

  <div class="content">
    <div class="alert alert-info mb-4">
      <span>â„¹ï¸</span>
      <div>Los usuarios se crean primero en Supabase Auth (con correo y contraseÃ±a), luego se registran aquÃ­ con su nombre y rol. El ID debe coincidir con el UUID de Supabase Auth.</div>
    </div>

    <div class="card">
      <div class="card-body" style="padding:0;">
        <table>
          <thead>
            <tr><th>Nombre</th><th>Grado</th><th>Rol</th><th>Ãrea</th><th>Estado</th><th>Acciones</th></tr>
          </thead>
          <tbody id="tabla-usuarios">
            <tr><td colspan="6" style="text-align:center;padding:30px;color:#888;">Cargando...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- MODAL USUARIO -->
<div class="modal-overlay" id="modal-usuario">
  <div class="modal">
    <div class="modal-header">
      <h3>ğŸ‘¤ Registrar Usuario</h3>
      <button class="modal-close" onclick="SIGO.closeModal('modal-usuario')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="alert alert-warning">
        <span>âš ï¸</span>
        <div>Primero crea el usuario en el panel de Supabase (Authentication â†’ Users) y copia el UUID generado.</div>
      </div>
      <div class="form-group">
        <label>UUID de Supabase Auth *</label>
        <input type="text" id="u-id" class="form-control" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Nombre Completo *</label>
          <input type="text" id="u-nombre" class="form-control" placeholder="Nombre Apellido">
        </div>
        <div class="form-group">
          <label>Grado</label>
          <input type="text" id="u-grado" class="form-control" placeholder="Ej: Sargento 2Â°">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Rol *</label>
          <select id="u-rol" class="form-control">
            <option value="USUARIO">Usuario</option>
            <option value="OPERACIONES">Operaciones</option>
            <option value="ADMIN">Admin</option>
          </select>
        </div>
        <div class="form-group">
          <label>Ãrea</label>
          <select id="u-area" class="form-control">
            <option value="Operaciones">Operaciones</option>
            <option value="SIP">SIP</option>
            <option value="OS2">OS2</option>
            <option value="OS3">OS3</option>
            <option value="Frontera">Frontera</option>
            <option value="Administrativo">Administrativo</option>
          </select>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="SIGO.closeModal('modal-usuario')">Cancelar</button>
      <button class="btn btn-primary" onclick="guardarUsuario()">ğŸ’¾ Registrar</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="js/supabase.js"></script>
<script>
let currentUser = null;

async function init() {
  currentUser = await SIGO.authGuard();
  if (!currentUser) return;
  const profile = await SIGO.getUserProfile(currentUser.id);
  document.getElementById('user-name').textContent = profile?.nombre || currentUser.email;
  document.getElementById('user-role').textContent = profile?.grado || profile?.rol || '';
  document.getElementById('user-avatar').textContent = (profile?.nombre || 'U')[0].toUpperCase();
  await cargarUsuarios();
}

async function cargarUsuarios() {
  const users = await SIGO.getUsuarios();
  const tbody = document.getElementById('tabla-usuarios');
  if (!users.length) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:30px;color:#888;">Sin usuarios registrados</td></tr>';
    return;
  }
  tbody.innerHTML = users.map(u => `
    <tr>
      <td><strong>${u.nombre}</strong></td>
      <td>${u.grado || 'â€”'}</td>
      <td><span class="badge ${u.rol === 'ADMIN' ? 'badge-critica' : u.rol === 'OPERACIONES' ? 'badge-tramite' : 'badge-normal'}">${u.rol}</span></td>
      <td>${u.area || 'â€”'}</td>
      <td><span class="badge ${u.activo ? 'badge-vigente' : 'badge-archivada'}">${u.activo ? 'Activo' : 'Inactivo'}</span></td>
      <td>
        <button class="btn btn-sm btn-danger" onclick="desactivar('${u.id}')">Desactivar</button>
      </td>
    </tr>`).join('');
}

async function guardarUsuario() {
  const id = document.getElementById('u-id').value.trim();
  const nombre = document.getElementById('u-nombre').value.trim();
  if (!id || !nombre) { SIGO.showToast('âš ï¸ UUID y nombre son obligatorios', 'warning'); return; }
  const { error } = await SIGO.db.from('users').insert([{
    id, nombre,
    grado: document.getElementById('u-grado').value,
    rol: document.getElementById('u-rol').value,
    area: document.getElementById('u-area').value,
    activo: true
  }]);
  if (error) { SIGO.showToast('âŒ Error: ' + error.message, 'danger'); return; }
  SIGO.showToast('âœ… Usuario registrado');
  SIGO.closeModal('modal-usuario');
  await cargarUsuarios();
}

async function desactivar(id) {
  if (!confirm('Â¿Desactivar este usuario?')) return;
  await SIGO.db.from('users').update({ activo: false }).eq('id', id);
  SIGO.showToast('Usuario desactivado');
  await cargarUsuarios();
}

init();
</script>
</body>
</html>
