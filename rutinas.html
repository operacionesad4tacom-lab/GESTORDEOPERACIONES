<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SIGO â€” Rutinas de SupervisiÃ³n</title>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>

<aside class="sidebar" id="sidebar">
  <div class="sidebar-logo">
    <img src="assets/escudo.jpg" alt="Carabineros">
    <div class="sidebar-logo-text"><span class="title">SIGO</span><span class="subtitle">GestiÃ³n Operacional</span></div>
  </div>
  <div class="sidebar-unit">4Âª ComisarÃ­a â€” Operaciones</div>
  <nav class="sidebar-nav">
    <div class="nav-section-label">Principal</div>
    <a class="nav-item" href="index.html"><span class="nav-icon">ğŸ </span> Vista de Turno</a>
    <a class="nav-item" href="tareas.html"><span class="nav-icon">ğŸ“‹</span> Tareas y Cuentas</a>
    <a class="nav-item" href="calendario.html"><span class="nav-icon">ğŸ“…</span> Calendario</a>
    <div class="nav-section-label">Gestiones</div>
    <a class="nav-item" href="gestiones.html"><span class="nav-icon">ğŸ”µ</span> Gestiones</a>
    <div class="nav-section-label">Documentos</div>
    <a class="nav-item" href="documentos.html"><span class="nav-icon">ğŸ“¥</span> Documentos DOE</a>
    <div class="nav-section-label">Control</div>
    <a class="nav-item active" href="rutinas.html"><span class="nav-icon">ğŸ”</span> Rutinas</a>
    <a class="nav-item" href="formatos.html"><span class="nav-icon">ğŸ“</span> Formatos Oficiales</a>
    <a class="nav-item" href="avisos.html"><span class="nav-icon">ğŸ“¢</span> Avisos</a>
    <div class="nav-section-label">Admin</div>
    <a class="nav-item" href="usuarios.html"><span class="nav-icon">ğŸ‘¤</span> Usuarios</a>
  </nav>
  <div class="sidebar-footer">
    <div class="user-avatar" id="user-avatar">?</div>
    <div class="user-info"><div class="name" id="user-name">Cargando...</div><div class="role" id="user-role">â€”</div></div>
    <button onclick="SIGO.logout()" style="background:none;border:none;color:rgba(255,255,255,0.5);cursor:pointer;font-size:16px;">â»</button>
  </div>
</aside>

<div class="main">
  <div class="topbar">
    <div class="topbar-title">Rutinas de SupervisiÃ³n</div>
    <button class="btn btn-primary" onclick="SIGO.openModal('modal-rutina')">â• Nueva Rutina</button>
  </div>

  <div class="content">

    <div class="stats-grid" style="grid-template-columns:repeat(3,1fr);">
      <div class="stat-card"><div class="stat-icon red">ğŸ”´</div><div class="stat-info"><div class="number" id="cnt-atrasadas">0</div><div class="label">Atrasadas</div></div></div>
      <div class="stat-card"><div class="stat-icon orange">ğŸŸ¡</div><div class="stat-info"><div class="number" id="cnt-proximas">0</div><div class="label">PrÃ³ximas a Vencer</div></div></div>
      <div class="stat-card"><div class="stat-icon green">ğŸŸ¢</div><div class="stat-info"><div class="number" id="cnt-vigentes">0</div><div class="label">Al DÃ­a</div></div></div>
    </div>

    <div class="card">
      <div class="card-body" style="padding:0;">
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Rutina</th>
                <th>Frecuencia</th>
                <th>Criticidad</th>
                <th>Responsable</th>
                <th>PrÃ³xima RevisiÃ³n</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tabla-rutinas">
              <tr><td colspan="7" style="text-align:center;padding:30px;color:#888;">Cargando...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL NUEVA RUTINA -->
<div class="modal-overlay" id="modal-rutina">
  <div class="modal">
    <div class="modal-header">
      <h3>ğŸ” Nueva Rutina de SupervisiÃ³n</h3>
      <button class="modal-close" onclick="SIGO.closeModal('modal-rutina')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Nombre *</label>
        <input type="text" id="r-nombre" class="form-control" placeholder="Ej: Panel Comando y Control">
      </div>
      <div class="form-group">
        <label>DescripciÃ³n</label>
        <textarea id="r-desc" class="form-control" rows="2" placeholder="QuÃ© debe verificarse..."></textarea>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Ãrea</label>
          <select id="r-area" class="form-control">
            <option value="Operaciones">Operaciones</option>
            <option value="SIP">SIP</option>
            <option value="OS2">OS2</option>
            <option value="OS3">OS3</option>
            <option value="Frontera">Frontera</option>
            <option value="Administrativo">Administrativo</option>
          </select>
        </div>
        <div class="form-group">
          <label>Frecuencia *</label>
          <select id="r-frecuencia" class="form-control">
            <option value="diaria">Diaria</option>
            <option value="semanal">Semanal</option>
            <option value="mensual">Mensual</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Criticidad</label>
          <select id="r-criticidad" class="form-control">
            <option value="critica">CrÃ­tica</option>
            <option value="alta">Alta</option>
            <option value="normal">Normal</option>
          </select>
        </div>
        <div class="form-group">
          <label>Responsable</label>
          <select id="r-responsable" class="form-control">
            <option value="">Seleccionar...</option>
          </select>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="SIGO.closeModal('modal-rutina')">Cancelar</button>
      <button class="btn btn-primary" onclick="guardarRutina()">ğŸ’¾ Guardar</button>
    </div>
  </div>
</div>

<!-- MODAL ACTUALIZAR RUTINA -->
<div class="modal-overlay" id="modal-act-rutina">
  <div class="modal" style="max-width:420px;">
    <div class="modal-header">
      <h3>âœ… Actualizar Rutina</h3>
      <button class="modal-close" onclick="SIGO.closeModal('modal-act-rutina')">âœ•</button>
    </div>
    <div class="modal-body">
      <p class="mb-4 fw-600" id="act-rutina-nombre"></p>
      <div class="form-group">
        <label>ObservaciÃ³n (opcional)</label>
        <textarea id="act-rutina-obs" class="form-control" rows="2" placeholder="Novedad o detalle de la actualizaciÃ³n..."></textarea>
      </div>
      <input type="hidden" id="act-rutina-id">
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="SIGO.closeModal('modal-act-rutina')">Cancelar</button>
      <button class="btn btn-primary" onclick="confirmarActualizacion()">âœ… Marcar como Actualizada</button>
    </div>
  </div>
</div>

<div class="sidebar-overlay" id="sidebar-overlay" onclick="SIGO.toggleSidebar()"></div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="js/supabase.js"></script>
<script>
let currentUser = null;

async function init() {
  currentUser = await SIGO.authGuard();
  if (!currentUser) return;
  const profile = await SIGO.getUserProfile(currentUser.id);
  document.getElementById('user-name').textContent = profile?.nombre || currentUser.email;
  document.getElementById('user-role').textContent = profile?.grado || profile?.rol || '';
  document.getElementById('user-avatar').textContent = (profile?.nombre || 'U')[0].toUpperCase();

  const users = await SIGO.getUsuarios();
  const sel = document.getElementById('r-responsable');
  users.forEach(u => {
    const opt = document.createElement('option');
    opt.value = u.id; opt.textContent = `${u.grado ? u.grado+' ' : ''}${u.nombre}`;
    sel.appendChild(opt);
  });

  await SIGO.verificarRutinasvencidas();
  await cargarRutinas();
}

async function cargarRutinas() {
  const rutinas = await SIGO.getRutinas();

  document.getElementById('cnt-atrasadas').textContent = rutinas.filter(r => r.estado === 'atrasada').length;
  document.getElementById('cnt-proximas').textContent  = rutinas.filter(r => r.estado === 'proxima').length;
  document.getElementById('cnt-vigentes').textContent  = rutinas.filter(r => r.estado === 'vigente').length;

  const tbody = document.getElementById('tabla-rutinas');
  if (!rutinas.length) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:30px;color:#888;">Sin rutinas configuradas</td></tr>';
    return;
  }

  tbody.innerHTML = rutinas.map(r => {
    const colorMap = { atrasada: '#c0392b', proxima: '#e67e22', vigente: '#04742c' };
    const color = colorMap[r.estado] || '#888';
    const estadoBadge = r.estado === 'atrasada'
      ? '<span class="badge badge-atrasada">ğŸ”´ Atrasada</span>'
      : r.estado === 'proxima'
      ? '<span class="badge badge-asignada">ğŸŸ¡ PrÃ³xima</span>'
      : '<span class="badge badge-vigente">ğŸŸ¢ Al DÃ­a</span>';

    return `
      <tr style="${r.estado === 'atrasada' ? 'background:#fff5f5;' : ''}">
        <td>
          <div style="display:flex;align-items:center;gap:8px;">
            <div style="width:8px;height:8px;border-radius:50%;background:${color};flex-shrink:0;"></div>
            <div>
              <strong>${r.nombre}</strong>
              <span class="badge badge-normal" style="margin-left:4px;">${r.area}</span>
              ${r.descripcion ? `<br><span class="text-sm text-muted">${r.descripcion}</span>` : ''}
            </div>
          </div>
        </td>
        <td><span class="badge badge-normal">${r.frecuencia}</span></td>
        <td>${SIGO.badgePrioridad(r.criticidad)}</td>
        <td>${r.responsable ? `${r.responsable.grado || ''} ${r.responsable.nombre}` : 'â€”'}</td>
        <td style="${r.estado === 'atrasada' ? 'color:var(--danger);font-weight:600;' : ''}">
          ${SIGO.formatFecha(r.proxima_revision)}
          <br><span class="text-sm text-muted">Ãšlt: ${SIGO.formatFecha(r.ultima_actualizacion)}</span>
        </td>
        <td>${estadoBadge}</td>
        <td>
          <button class="btn btn-sm btn-primary" onclick="abrirActualizar('${r.id}','${r.nombre}')">âœ… Actualizar</button>
          <button class="btn btn-sm btn-danger" onclick="archivarRutina('${r.id}')">ğŸ—„</button>
        </td>
      </tr>`;
  }).join('');
}

async function guardarRutina() {
  const nombre = document.getElementById('r-nombre').value.trim();
  if (!nombre) { SIGO.showToast('âš ï¸ Ingrese el nombre', 'warning'); return; }

  const frecuencia = document.getElementById('r-frecuencia').value;
  const ahora = new Date();
  let proxima = new Date(ahora);
  if (frecuencia === 'diaria')   proxima.setDate(proxima.getDate() + 1);
  if (frecuencia === 'semanal')  proxima.setDate(proxima.getDate() + 7);
  if (frecuencia === 'mensual')  proxima.setMonth(proxima.getMonth() + 1);

  const rutina = {
    nombre, descripcion: document.getElementById('r-desc').value,
    area: document.getElementById('r-area').value,
    frecuencia,
    criticidad: document.getElementById('r-criticidad').value,
    responsable_id: document.getElementById('r-responsable').value || null,
    ultima_actualizacion: ahora.toISOString(),
    proxima_revision: proxima.toISOString(),
    estado: 'vigente',
    activa: true
  };

  const { error } = await SIGO.db.from('rutinas_control').insert([rutina]);
  if (error) { SIGO.showToast('âŒ Error al guardar', 'danger'); return; }
  SIGO.showToast('âœ… Rutina creada');
  SIGO.closeModal('modal-rutina');
  await cargarRutinas();
}

function abrirActualizar(id, nombre) {
  document.getElementById('act-rutina-id').value = id;
  document.getElementById('act-rutina-nombre').textContent = nombre;
  document.getElementById('act-rutina-obs').value = '';
  SIGO.openModal('modal-act-rutina');
}

async function confirmarActualizacion() {
  const id = document.getElementById('act-rutina-id').value;
  const obs = document.getElementById('act-rutina-obs').value;
  await SIGO.actualizarRutina(id, currentUser.id, obs);
  SIGO.showToast('âœ… Rutina actualizada correctamente');
  SIGO.closeModal('modal-act-rutina');
  await cargarRutinas();
}

async function archivarRutina(id) {
  if (!confirm('Â¿Archivar esta rutina?')) return;
  await SIGO.db.from('rutinas_control').update({ activa: false }).eq('id', id);
  SIGO.showToast('ğŸ—„ Rutina archivada');
  await cargarRutinas();
}

init();
</script>
</body>
</html>
