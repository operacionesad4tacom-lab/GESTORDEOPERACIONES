<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SIGO â€” Calendario Operacional</title>
  <link rel="stylesheet" href="css/styles.css">
  <style>
    .cal-day { min-height: 80px; aspect-ratio: unset; flex-direction: column; align-items: flex-start; padding: 6px 8px; }
    .cal-num { font-size: 13px; }
    .cal-task-chip { font-size: 10px; padding: 1px 6px; border-radius: 10px; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; display: block; cursor: pointer; }
    .chip-pendiente { background: #fdecea; color: #c0392b; }
    .chip-finalizada { background: #e8f5ec; color: #04742c; }
    .chip-asignada { background: #fef3e2; color: #e67e22; }
    .chip-ejecucion { background: #e3f0fb; color: #2980b9; }
  </style>
</head>
<body>

<aside class="sidebar">
  <div class="sidebar-logo">
    <img src="assets/escudo.jpg" alt="Carabineros">
    <div class="sidebar-logo-text"><span class="title">SIGO</span><span class="subtitle">GestiÃ³n Operacional</span></div>
  </div>
  <div class="sidebar-unit">4Âª ComisarÃ­a â€” Operaciones</div>
  <nav class="sidebar-nav">
    <div class="nav-section-label">Principal</div>
    <a class="nav-item" href="index.html"><span class="nav-icon">ğŸ </span> Dashboard</a>
    <a class="nav-item" href="tareas.html"><span class="nav-icon">ğŸ“‹</span> Tareas y Cuentas</a>
    <a class="nav-item active" href="calendario.html"><span class="nav-icon">ğŸ“…</span> Calendario</a>
    <div class="nav-section-label">Documentos</div>
    <a class="nav-item" href="documentos.html"><span class="nav-icon">ğŸ“¥</span> Documentos DOE</a>
    <div class="nav-section-label">Control</div>
    <a class="nav-item" href="rutinas.html"><span class="nav-icon">ğŸ”</span> Rutinas</a>
    <a class="nav-item" href="formatos.html"><span class="nav-icon">ğŸ“</span> Formatos Oficiales</a>
    <a class="nav-item" href="avisos.html"><span class="nav-icon">ğŸ“¢</span> Avisos</a>
    <div class="nav-section-label">Admin</div>
    <a class="nav-item" href="usuarios.html"><span class="nav-icon">ğŸ‘¤</span> Usuarios</a>
  </nav>
  <div class="sidebar-footer">
    <div class="user-avatar" id="user-avatar">?</div>
    <div class="user-info"><div class="name" id="user-name">Cargando...</div><div class="role" id="user-role">â€”</div></div>
    <button onclick="SIGO.logout()" style="background:none;border:none;color:rgba(255,255,255,0.5);cursor:pointer;font-size:16px;">â»</button>
  </div>
</aside>

<div class="main">
  <div class="topbar">
    <div class="topbar-title">Calendario Operacional</div>
    <div style="display:flex;gap:10px;align-items:center;">
      <button class="btn btn-outline" onclick="mesAnterior()">â—€</button>
      <span id="mes-titulo" style="font-weight:700;font-size:16px;min-width:180px;text-align:center;"></span>
      <button class="btn btn-outline" onclick="mesSiguiente()">â–¶</button>
      <button class="btn btn-secondary" onclick="irHoy()">Hoy</button>
    </div>
  </div>

  <div class="content">
    <div class="grid-2-1" style="gap:20px;">

      <!-- CALENDARIO MENSUAL -->
      <div class="card">
        <div class="card-body">
          <div class="calendar-grid" id="cal-grid"></div>
        </div>
      </div>

      <!-- DETALLE DÃA SELECCIONADO -->
      <div>
        <div class="card">
          <div class="card-header">
            <h3>ğŸ“‹ <span id="detalle-fecha-titulo">Selecciona un dÃ­a</span></h3>
          </div>
          <div class="card-body" id="detalle-dia" style="padding:12px;">
            <div style="text-align:center;color:#aaa;padding:20px;">Haz clic en un dÃ­a del calendario</div>
          </div>
        </div>
      </div>
    </div>

    <!-- LEYENDA -->
    <div class="card" style="margin-top:16px;">
      <div class="card-body" style="padding:12px 20px;">
        <div style="display:flex;gap:20px;flex-wrap:wrap;align-items:center;">
          <strong style="font-size:12px;">Leyenda:</strong>
          <span><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#c0392b;margin-right:4px;"></span>Atrasado / Pendiente</span>
          <span><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#e67e22;margin-right:4px;"></span>En Proceso</span>
          <span><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#04742c;margin-right:4px;"></span>Completado</span>
          <span><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#2980b9;margin-right:4px;"></span>Programado</span>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="js/supabase.js"></script>
<script>
let currentUser = null;
let mesActual = new Date();
let diaSeleccionado = null;
let todasLasTareas = [];

async function init() {
  currentUser = await SIGO.authGuard();
  if (!currentUser) return;
  const profile = await SIGO.getUserProfile(currentUser.id);
  document.getElementById('user-name').textContent = profile?.nombre || currentUser.email;
  document.getElementById('user-role').textContent = profile?.grado || profile?.rol || '';
  document.getElementById('user-avatar').textContent = (profile?.nombre || 'U')[0].toUpperCase();

  todasLasTareas = await SIGO.getTareas();
  renderCalendario();
  seleccionarDia(new Date());
}

function renderCalendario() {
  const grid = document.getElementById('cal-grid');
  const aÃ±o = mesActual.getFullYear();
  const mes = mesActual.getMonth();

  document.getElementById('mes-titulo').textContent =
    mesActual.toLocaleDateString('es-CL', { month: 'long', year: 'numeric' }).toUpperCase();

  const dias = ['LUN','MAR','MIÃ‰','JUE','VIE','SÃB','DOM'];
  let html = dias.map(d => `<div class="cal-day-header">${d}</div>`).join('');

  const primerDia = new Date(aÃ±o, mes, 1);
  const ultimoDia = new Date(aÃ±o, mes + 1, 0);
  let inicioGrid = primerDia.getDay();
  if (inicioGrid === 0) inicioGrid = 7;
  inicioGrid--;

  // DÃ­as del mes anterior
  for (let i = inicioGrid - 1; i >= 0; i--) {
    const fecha = new Date(aÃ±o, mes, -i);
    html += diaHTML(fecha, true);
  }

  // DÃ­as del mes
  for (let d = 1; d <= ultimoDia.getDate(); d++) {
    const fecha = new Date(aÃ±o, mes, d);
    html += diaHTML(fecha, false);
  }

  // DÃ­as siguientes
  const totalCeldas = inicioGrid + ultimoDia.getDate();
  const restantes = totalCeldas % 7 === 0 ? 0 : 7 - (totalCeldas % 7);
  for (let i = 1; i <= restantes; i++) {
    const fecha = new Date(aÃ±o, mes + 1, i);
    html += diaHTML(fecha, true);
  }

  grid.innerHTML = html;
}

function diaHTML(fecha, otroMes) {
  const iso = fecha.toISOString().split('T')[0];
  const hoy = new Date().toISOString().split('T')[0];
  const selIso = diaSeleccionado ? diaSeleccionado.toISOString().split('T')[0] : null;
  const tareasDelDia = getTareasParaFecha(fecha);

  let clases = 'cal-day';
  if (otroMes) clases += ' other-month';
  if (iso === hoy) clases += ' today';
  if (iso === selIso) clases += ' selected';

  const chipCount = Math.min(tareasDelDia.length, 3);
  const chips = tareasDelDia.slice(0, chipCount).map(t => {
    const cls = t.estado === 'finalizada' ? 'chip-finalizada' :
                ['asignada'].includes(t.estado) ? 'chip-asignada' :
                t.estado === 'en_ejecucion' ? 'chip-ejecucion' : 'chip-pendiente';
    return `<span class="cal-task-chip ${cls}">${t.titulo}</span>`;
  }).join('');

  const extra = tareasDelDia.length > chipCount ? `<span style="font-size:9px;color:#888;">+${tareasDelDia.length - chipCount} mÃ¡s</span>` : '';

  return `<div class="${clases}" onclick="seleccionarDia(new Date('${iso}T12:00:00'))">
    <span class="cal-num">${fecha.getDate()}</span>
    ${chips}${extra}
  </div>`;
}

function getTareasParaFecha(fecha) {
  const diaSemana = fecha.getDay() === 0 ? 7 : fecha.getDay();
  const diaMes = fecha.getDate();
  const iso = fecha.toISOString().split('T')[0];

  return todasLasTareas.filter(t => {
    if (t.tipo === 'diaria') return true;
    if (t.tipo === 'semanal' && t.dia_semana == diaSemana) return true;
    if (t.tipo === 'mensual' && t.dia_mes == diaMes) return true;
    if (t.tipo === 'quincenal' && [1, 15].includes(diaMes)) return true;
    if (t.tipo === 'extraordinaria' && t.fecha_programada === iso) return true;
    return false;
  });
}

async function seleccionarDia(fecha) {
  diaSeleccionado = fecha;
  renderCalendario();

  const iso = fecha.toISOString().split('T')[0];
  document.getElementById('detalle-fecha-titulo').textContent =
    fecha.toLocaleDateString('es-CL', { weekday: 'long', day: 'numeric', month: 'long' });

  const tareas = getTareasParaFecha(fecha);
  const el = document.getElementById('detalle-dia');

  if (!tareas.length) {
    el.innerHTML = '<div style="text-align:center;color:#aaa;padding:16px;font-size:13px;">Sin tareas para este dÃ­a</div>';
    return;
  }

  el.innerHTML = tareas.map(t => `
    <div style="padding:8px 0;border-bottom:1px solid var(--border);">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
        <strong style="font-size:13px;">${t.titulo}</strong>
        ${SIGO.badgeEstadoTarea(t.estado)}
      </div>
      <div style="font-size:11px;color:var(--text-secondary);display:flex;gap:10px;flex-wrap:wrap;">
        ${t.hora_limite ? `<span>â° ${t.hora_limite}</span>` : ''}
        ${t.responsable ? `<span>ğŸ‘¤ ${t.responsable.nombre}</span>` : ''}
        ${SIGO.badgePrioridad(t.prioridad)}
        <span class="badge badge-normal">${t.tipo}</span>
      </div>
    </div>`).join('');
}

function mesAnterior() { mesActual.setMonth(mesActual.getMonth() - 1); renderCalendario(); }
function mesSiguiente() { mesActual.setMonth(mesActual.getMonth() + 1); renderCalendario(); }
function irHoy() { mesActual = new Date(); seleccionarDia(new Date()); }

init();
</script>
</body>
</html>
